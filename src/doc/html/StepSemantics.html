<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">

<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>Module StepSemantics</title>
<meta name="description" content="Documentation of Coq module StepSemantics" />
<link href="coq2html.css" rel="stylesheet" type="text/css" />
<script type="text/javascript" src="coq2html.js"> </script>
</head>

<body onload="hideAll('proofscript')">
<h1 class="title">Module StepSemantics</h1>
<div class="coq">
<br/>
<span class="kwd">Require</span> <span class="kwd">Import</span> <span class="id">ZArith</span> <span class="id">List</span> <span class="id">String</span> <span class="id">Omega</span>.<br/>
<span class="kwd">Require</span> <span class="id">Coq.FSets.FMapAVL</span>.<br/>
<span class="kwd">Require</span> <span class="id">Coq.FSets.FMapFacts</span>.<br/>
<span class="kwd">Require</span> <span class="id">Coq.Structures.OrderedTypeEx</span>.<br/>
<br/>
<span class="kwd">Require</span> <span class="kwd">Import</span> <span class="id">compcert.lib.Integers</span> <span class="id">compcert.lib.Floats</span>.<br/>
<br/>
<span class="kwd">Require</span> <span class="kwd">Import</span> <span class="id">Vellvm.Classes</span>.<br/>
<span class="kwd">Require</span> <span class="kwd">Import</span> <span class="id">Vellvm.Util</span>.<br/>
<span class="kwd">Require</span> <span class="kwd">Import</span> <span class="id">Vellvm.Trace</span>.<br/>
<span class="kwd">Require</span> <span class="kwd">Import</span> <span class="id">Vellvm.LLVMAst</span>.<br/>
<span class="kwd">Require</span> <span class="kwd">Import</span> <span class="id">Vellvm.AstLib</span>.<br/>
<span class="kwd">Require</span> <span class="kwd">Import</span> <span class="id">Vellvm.CFG</span>.<br/>
<span class="kwd">Require</span> <span class="kwd">Import</span> <span class="id">Vellvm.MemoryAddress</span>.<br/>
<span class="kwd">Require</span> <span class="kwd">Import</span> <span class="id">Vellvm.LLVMIO</span>.<br/>
<span class="kwd">Require</span> <span class="kwd">Import</span> <span class="id">Vellvm.DynamicValues</span>.<br/>
<span class="kwd">Require</span> <span class="kwd">Import</span> <span class="id">Vellvm.TypeUtil</span>.<br/>
<span class="kwd">Import</span> <span class="id">ListNotations</span>.<br/>
<br/>
<br/>
<span class="kwd">Set</span> <span class="kwd">Implicit</span> <span class="id">Arguments</span>.<br/>
<span class="kwd">Set</span> <span class="id">Contextual</span> <span class="kwd">Implicit</span>.<br/>
<br/>
<span class="kwd">Open</span> <span class="kwd">Scope</span> <span class="id">Z_scope</span>.<br/>
<span class="kwd">Open</span> <span class="kwd">Scope</span> <span class="id">string_scope</span>.<br/>
<br/>
<span class="kwd">Module</span> <span class="id">StepSemantics</span>(<span class="id">A</span>:<span class="id">MemoryAddress.ADDRESS</span>)(<span class="id">LLVMIO</span>:<span class="id">LLVM_INTERACTIONS</span>(<span class="id">A</span>)).<br/>
&nbsp;&nbsp;<br/>
&nbsp;&nbsp;<span class="kwd">Import</span> <span class="id">LLVMIO</span>.<br/>
&nbsp;&nbsp;<br/>
&nbsp;&nbsp;<span class="kwd">Module</span> <span class="id">ENV</span> := <span class="id">FMapAVL.Make</span>(<span class="id">AstLib.RawIDOrd</span>).<br/>
&nbsp;&nbsp;<span class="kwd">Module</span> <span class="id">ENVFacts</span> := <span class="id">FMapFacts.WFacts_fun</span>(<span class="id">AstLib.RawIDOrd</span>)(<span class="id">ENV</span>).<br/>
&nbsp;&nbsp;<span class="kwd">Module</span> <span class="id">ENVProps</span> := <span class="id">FMapFacts.WProperties_fun</span>(<span class="id">AstLib.RawIDOrd</span>)(<span class="id">ENV</span>).<br/>
&nbsp;&nbsp;<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">env_of_assoc</span> {<span class="id">A</span>} (<span class="id">l</span>:<span class="id">list</span> (<span class="id">raw_id</span> * <span class="id">A</span>)) : <span class="id">ENV.t</span> <span class="id">A</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">List.fold_left</span> (<span class="kwd">fun</span> <span class="id">e</span> '(<span class="id">k</span>,<span class="id">v</span>) =&gt; <span class="id">ENV.add</span> <span class="id">k</span> <span class="id">v</span> <span class="id">e</span>) <span class="id">l</span> (@<span class="id">ENV.empty</span> <span class="id">A</span>).<br/>
&nbsp;&nbsp;<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">genv</span> := <span class="id">ENV.t</span> <span class="id">dvalue</span>.<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">env</span>  := <span class="id">ENV.t</span> <span class="id">dvalue</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Inductive</span> <span class="id">frame</span> : <span class="kwd">Type</span> :=<br/>
&nbsp;&nbsp;| <span class="id">KRet</span>      (<span class="id">e</span>:<span class="id">env</span>) (<span class="id">id</span>:<span class="id">local_id</span>) (<span class="id">q</span>:<span class="id">pc</span>)<br/>
&nbsp;&nbsp;| <span class="id">KRet_void</span> (<span class="id">e</span>:<span class="id">env</span>) (<span class="id">p</span>:<span class="id">pc</span>)<br/>
&nbsp;&nbsp;.       <br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">stack</span> := <span class="id">list</span> <span class="id">frame</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">state</span> := (<span class="id">genv</span> * <span class="id">pc</span> * <span class="id">env</span> * <span class="id">stack</span>)%<span class="id">type</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">pc_of</span> (<span class="id">s</span>:<span class="id">state</span>) :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">let</span> '(<span class="id">g</span>, <span class="id">p</span>, <span class="id">e</span>, <span class="id">k</span>) := <span class="id">s</span> <span class="kwd">in</span> <span class="id">p</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">env_of</span> (<span class="id">s</span>:<span class="id">state</span>) :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">let</span> '(<span class="id">g</span>, <span class="id">p</span>, <span class="id">e</span>, <span class="id">k</span>) := <span class="id">s</span> <span class="kwd">in</span> <span class="id">e</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">stack_of</span> (<span class="id">s</span>:<span class="id">state</span>) :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">let</span> '(<span class="id">g</span>, <span class="id">p</span>, <span class="id">e</span>, <span class="id">k</span>) := <span class="id">s</span> <span class="kwd">in</span> <span class="id">k</span>.<br/>
&nbsp;&nbsp;<br/>
&nbsp;&nbsp;<span class="kwd">Fixpoint</span> <span class="id">string_of_env</span>' (<span class="id">e</span>:<span class="id">list</span> (<span class="id">raw_id</span> * <span class="id">dvalue</span>)) : <span class="id">string</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">e</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| [] =&gt; ""<br/>
&nbsp;&nbsp;&nbsp;&nbsp;| (<span class="id">lid</span>, <span class="id">_</span>)::<span class="id">rest</span> =&gt; (<span class="id">string_of_raw_id</span> <span class="id">lid</span>) ++ " " ++ (<span class="id">string_of_env</span>' <span class="id">rest</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">end</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Instance</span> <span class="id">string_of_env</span> : <span class="id">StringOf</span> <span class="id">env</span> := <span class="kwd">fun</span> <span class="id">env</span> =&gt; <span class="id">string_of_env</span>' (<span class="id">ENV.elements</span> <span class="id">env</span>).<br/>
&nbsp;&nbsp;<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">lookup_env</span> {<span class="id">X</span>} (<span class="id">e</span>:<span class="id">ENV.t</span> <span class="id">X</span>) (<span class="id">id</span>:<span class="id">raw_id</span>) : <span class="id">err</span> <span class="id">X</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">ENV.find</span> <span class="id">id</span> <span class="id">e</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">Some</span> <span class="id">v</span> =&gt; <span class="id">mret</span> <span class="id">v</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">None</span> =&gt; <span class="id">failwith</span> "<span class="id">lookup_env</span>: <span class="id">failed</span> <span class="id">to</span> <span class="id">find</span> <span class="id">id</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">end</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">lookup_id</span> (<span class="id">g</span>:<span class="id">genv</span>) (<span class="id">e</span>:<span class="id">env</span>) (<span class="id">i</span>:<span class="id">ident</span>) : <span class="id">err</span> <span class="id">dvalue</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">i</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">ID_Global</span> <span class="id">x</span> =&gt; <span class="id">lookup_env</span> <span class="id">g</span> <span class="id">x</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">ID_Local</span> <span class="id">x</span> =&gt; <span class="id">lookup_env</span> <span class="id">e</span> <span class="id">x</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">end</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">reverse_lookup_function_id</span> (<span class="id">g</span>:<span class="id">genv</span>) (<span class="id">a</span>:<span class="id">A.addr</span>) : <span class="id">err</span> <span class="id">raw_id</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">let</span> <span class="id">f</span> <span class="id">x</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">x</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| (<span class="id">_</span>, <span class="id">DVALUE_Addr</span> <span class="id">b</span>) =&gt; <span class="kwd">if</span> <span class="id">a</span> == <span class="id">b</span> <span class="kwd">then</span> <span class="id">true</span> <span class="kwd">else</span> <span class="id">false</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">_</span> =&gt; <span class="id">false</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">end</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">List.find</span> <span class="id">f</span> (<span class="id">ENV.elements</span> <span class="id">g</span>) <span class="kwd">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">None</span> =&gt; <span class="id">failwith</span> "<span class="id">reverse_lookup_function_id</span> <span class="id">failed</span>"<br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">Some</span> (<span class="id">fid</span>, <span class="id">_</span>) =&gt; <span class="id">mret</span> <span class="id">fid</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">end</span>.<br/>
&nbsp;&nbsp;<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">add_env</span> := <span class="id">ENV.add</span>.<br/>
<br/>
&nbsp;&nbsp;<br/>
&nbsp;&nbsp;<span class="kwd">Section</span> <span class="id">CONVERSIONS</span>.<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">eval_conv_h</span> <span class="id">conv</span> <span class="id">t1</span> <span class="id">x</span> <span class="id">t2</span> : <span class="id">Trace</span> <span class="id">dvalue</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">conv</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">Trunc</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">t1</span>, <span class="id">x</span>, <span class="id">t2</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">TYPE_I</span> 8, <span class="id">DVALUE_I8</span> <span class="id">i1</span>, <span class="id">TYPE_I</span> 1 =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">mret</span> (<span class="id">DVALUE_I1</span> (<span class="id">Int1.repr</span> (<span class="id">Int8.unsigned</span> <span class="id">i1</span>)))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">TYPE_I</span> 32, <span class="id">DVALUE_I32</span> <span class="id">i1</span>, <span class="id">TYPE_I</span> 1 =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">mret</span> (<span class="id">DVALUE_I1</span> (<span class="id">Int1.repr</span> (<span class="id">Int32.unsigned</span> <span class="id">i1</span>)))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">TYPE_I</span> 32, <span class="id">DVALUE_I32</span> <span class="id">i1</span>, <span class="id">TYPE_I</span> 8 =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">mret</span> (<span class="id">DVALUE_I8</span> (<span class="id">Int8.repr</span> (<span class="id">Int32.unsigned</span> <span class="id">i1</span>)))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">TYPE_I</span> 64, <span class="id">DVALUE_I64</span> <span class="id">i1</span>, <span class="id">TYPE_I</span> 1 =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">mret</span> (<span class="id">DVALUE_I1</span> (<span class="id">Int1.repr</span> (<span class="id">Int64.unsigned</span> <span class="id">i1</span>)))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">TYPE_I</span> 64, <span class="id">DVALUE_I64</span> <span class="id">i1</span>, <span class="id">TYPE_I</span> 8 =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">mret</span> (<span class="id">DVALUE_I8</span> (<span class="id">Int8.repr</span> (<span class="id">Int64.unsigned</span> <span class="id">i1</span>)))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">TYPE_I</span> 64, <span class="id">DVALUE_I64</span> <span class="id">i1</span>, <span class="id">TYPE_I</span> 32 =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">mret</span> (<span class="id">DVALUE_I32</span> (<span class="id">Int32.repr</span> (<span class="id">Int64.unsigned</span> <span class="id">i1</span>)))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">_</span>, <span class="id">_</span>, <span class="id">_</span> =&gt; <span class="id">failwith</span> "<span class="id">ill</span> <span class="id">typed</span>-<span class="id">conv</span>"<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">end</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">Zext</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">t1</span>, <span class="id">x</span>, <span class="id">t2</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">TYPE_I</span> 1, <span class="id">DVALUE_I1</span> <span class="id">i1</span>, <span class="id">TYPE_I</span> 8 =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">mret</span> (<span class="id">DVALUE_I8</span> (<span class="id">Int8.repr</span> (<span class="id">Int1.unsigned</span> <span class="id">i1</span>)))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">TYPE_I</span> 1, <span class="id">DVALUE_I1</span> <span class="id">i1</span>, <span class="id">TYPE_I</span> 32 =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">mret</span> (<span class="id">DVALUE_I32</span> (<span class="id">Int32.repr</span> (<span class="id">Int1.unsigned</span> <span class="id">i1</span>)))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">TYPE_I</span> 1, <span class="id">DVALUE_I1</span> <span class="id">i1</span>, <span class="id">TYPE_I</span> 64 =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">mret</span> (<span class="id">DVALUE_I64</span> (<span class="id">Int64.repr</span> (<span class="id">Int1.unsigned</span> <span class="id">i1</span>)))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">TYPE_I</span> 8, <span class="id">DVALUE_I8</span> <span class="id">i1</span>, <span class="id">TYPE_I</span> 32 =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">mret</span> (<span class="id">DVALUE_I32</span> (<span class="id">Int32.repr</span> (<span class="id">Int8.unsigned</span> <span class="id">i1</span>)))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">TYPE_I</span> 8, <span class="id">DVALUE_I8</span> <span class="id">i1</span>, <span class="id">TYPE_I</span> 64 =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">mret</span> (<span class="id">DVALUE_I64</span> (<span class="id">Int64.repr</span> (<span class="id">Int8.unsigned</span> <span class="id">i1</span>)))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">TYPE_I</span> 32, <span class="id">DVALUE_I32</span> <span class="id">i1</span>, <span class="id">TYPE_I</span> 64 =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">mret</span> (<span class="id">DVALUE_I64</span> (<span class="id">Int64.repr</span> (<span class="id">Int32.unsigned</span> <span class="id">i1</span>)))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">_</span>, <span class="id">_</span>, <span class="id">_</span> =&gt; <span class="id">failwith</span> "<span class="id">ill</span> <span class="id">typed</span>-<span class="id">conv</span>"<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">end</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">Sext</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">t1</span>, <span class="id">x</span>, <span class="id">t2</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">TYPE_I</span> 1, <span class="id">DVALUE_I1</span> <span class="id">i1</span>, <span class="id">TYPE_I</span> 8 =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">mret</span> (<span class="id">DVALUE_I8</span> (<span class="id">Int8.repr</span> (<span class="id">Int1.signed</span> <span class="id">i1</span>)))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">TYPE_I</span> 1, <span class="id">DVALUE_I1</span> <span class="id">i1</span>, <span class="id">TYPE_I</span> 32 =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">mret</span> (<span class="id">DVALUE_I32</span> (<span class="id">Int32.repr</span> (<span class="id">Int1.signed</span> <span class="id">i1</span>)))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">TYPE_I</span> 1, <span class="id">DVALUE_I1</span> <span class="id">i1</span>, <span class="id">TYPE_I</span> 64 =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">mret</span> (<span class="id">DVALUE_I64</span> (<span class="id">Int64.repr</span> (<span class="id">Int1.signed</span> <span class="id">i1</span>)))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">TYPE_I</span> 8, <span class="id">DVALUE_I8</span> <span class="id">i1</span>, <span class="id">TYPE_I</span> 32 =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">mret</span> (<span class="id">DVALUE_I32</span> (<span class="id">Int32.repr</span> (<span class="id">Int8.signed</span> <span class="id">i1</span>)))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">TYPE_I</span> 8, <span class="id">DVALUE_I8</span> <span class="id">i1</span>, <span class="id">TYPE_I</span> 64 =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">mret</span> (<span class="id">DVALUE_I64</span> (<span class="id">Int64.repr</span> (<span class="id">Int8.signed</span> <span class="id">i1</span>)))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">TYPE_I</span> 32, <span class="id">DVALUE_I32</span> <span class="id">i1</span>, <span class="id">TYPE_I</span> 64 =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">mret</span> (<span class="id">DVALUE_I64</span> (<span class="id">Int64.repr</span> (<span class="id">Int32.signed</span> <span class="id">i1</span>)))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">_</span>, <span class="id">_</span>, <span class="id">_</span> =&gt; <span class="id">failwith</span> "<span class="id">ill</span> <span class="id">typed</span>-<span class="id">conv</span>"<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">end</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">Bitcast</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">t1</span>, <span class="id">x</span>, <span class="id">t2</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">TYPE_I</span> <span class="id">bits1</span>, <span class="id">x</span>, <span class="id">TYPE_I</span> <span class="id">bits2</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">if</span> <span class="id">bits1</span> =? <span class="id">bits2</span> <span class="kwd">then</span> <span class="id">mret</span> <span class="id">x</span> <span class="kwd">else</span> <span class="id">failwith</span> "<span class="id">unequal</span> <span class="id">bitsize</span> <span class="kwd">in</span> <span class="id">cast</span>"<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">TYPE_Pointer</span> <span class="id">t1</span>, <span class="id">DVALUE_Addr</span> <span class="id">a</span>, <span class="id">TYPE_Pointer</span> <span class="id">t2</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">mret</span> (<span class="id">DVALUE_Addr</span> <span class="id">a</span>) <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">_</span>, <span class="id">_</span>, <span class="id">_</span> =&gt; <span class="id">failwith</span> "<span class="id">ill</span>-<span class="id">typed_conv</span>"<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">end</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">Fptrunc</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">Fpext</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">Uitofp</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">Sitofp</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">Fptoui</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">Fptosi</span> =&gt; <span class="id">failwith</span> "<span class="id">TODO</span>: <span class="id">floating</span> <span class="id">point</span> <span class="id">conversion</span> <span class="id">not</span> <span class="id">yet</span> <span class="id">implemented</span>"<br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">Inttoptr</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">t1</span>, <span class="id">t2</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">TYPE_I</span> 64, <span class="id">TYPE_Pointer</span> <span class="id">t</span> =&gt; <span class="id">Trace.Vis</span> (<span class="id">ItoP</span> <span class="id">x</span>) <span class="id">mret</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">_</span>, <span class="id">_</span> =&gt; <span class="id">raise</span> "<span class="id">ERROR</span>: <span class="id">Inttoptr</span> <span class="id">got</span> <span class="id">illegal</span> <span class="id">arguments</span>"<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">end</span> <br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">Ptrtoint</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">t1</span>, <span class="id">t2</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">TYPE_Pointer</span> <span class="id">t</span>, <span class="id">TYPE_I</span> 64 =&gt; <span class="id">Trace.Vis</span> (<span class="id">PtoI</span> <span class="id">x</span>) <span class="id">mret</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">_</span>, <span class="id">_</span> =&gt; <span class="id">raise</span> "<span class="id">ERROR</span>: <span class="id">Ptrtoint</span> <span class="id">got</span> <span class="id">illegal</span> <span class="id">arguments</span>"<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">end</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">end</span>.<br/>
&nbsp;&nbsp;<span class="id">Arguments</span> <span class="id">eval_conv_h</span> <span class="id">_</span> <span class="id">_</span> <span class="id">_</span> <span class="id">_</span> : <span class="tactic">simpl</span> <span class="id">nomatch</span>.<br/>
<br/>
&nbsp;&nbsp;<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">eval_conv</span> <span class="id">conv</span> <span class="id">t1</span> <span class="id">x</span> <span class="id">t2</span> : <span class="id">Trace</span> <span class="id">dvalue</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">t1</span>, <span class="id">x</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">TYPE_I</span> <span class="id">bits</span>, <span class="id">dv</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">eval_conv_h</span> <span class="id">conv</span> <span class="id">t1</span> <span class="id">dv</span> <span class="id">t2</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">TYPE_Vector</span> <span class="id">s</span> <span class="id">t</span>, (<span class="id">DVALUE_Vector</span> <span class="id">elts</span>) =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">failwith</span> "<span class="id">vectors</span> <span class="id">unimplemented</span>"<br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">_</span>, <span class="id">_</span> =&gt; <span class="id">eval_conv_h</span> <span class="id">conv</span> <span class="id">t1</span> <span class="id">x</span> <span class="id">t2</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">end</span>.<br/>
&nbsp;&nbsp;<span class="id">Arguments</span> <span class="id">eval_conv</span> <span class="id">_</span> <span class="id">_</span> <span class="id">_</span> <span class="id">_</span> : <span class="tactic">simpl</span> <span class="id">nomatch</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">End</span> <span class="id">CONVERSIONS</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">dv_zero_initializer</span> (<span class="id">t</span>:<span class="id">dtyp</span>) : <span class="id">err</span> <span class="id">dvalue</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">failwith</span> "<span class="id">dv_zero_initializer</span> <span class="id">unimplemented</span>".<br/>
<br/>
<br/>
<span class="kwd">Section</span> <span class="id">IN_CFG_CONTEXT</span>.<br/>
<span class="kwd">Variable</span> <span class="id">CFG</span>:<span class="id">mcfg</span>.<br/>
<br/>
<span class="kwd">Definition</span> <span class="id">eval_typ</span> (<span class="id">t</span>:<span class="id">typ</span>) : <span class="id">dtyp</span> :=<br/>
&nbsp;&nbsp;<span class="id">TypeUtil.normalize_type_dtyp</span> (<span class="id">m_type_defs</span> <span class="id">CFG</span>) <span class="id">t</span>.<br/>
<br/>
<br/>
<span class="kwd">Section</span> <span class="id">IN_LOCAL_ENVIRONMENT</span>.<br/>
<span class="kwd">Variable</span> <span class="id">g</span> : <span class="id">genv</span>.<br/>
<span class="kwd">Variable</span> <span class="id">e</span> : <span class="id">env</span>.<br/>
<br/>
<span class="kwd">Fixpoint</span> <span class="id">eval_exp</span> (<span class="id">top</span>:<span class="id">option</span> <span class="id">dtyp</span>) (<span class="id">o</span>:<span class="id">exp</span>) {<span class="kwd">struct</span> <span class="id">o</span>} : <span class="id">Trace</span> <span class="id">dvalue</span> :=<br/>
&nbsp;&nbsp;<span class="kwd">let</span> <span class="id">eval_texp</span> '(<span class="id">t</span>,<span class="id">ex</span>) :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">let</span> <span class="id">dt</span> := <span class="id">eval_typ</span> <span class="id">t</span> <span class="kwd">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'<span class="id">v</span> &lt;- <span class="id">eval_exp</span> (<span class="id">Some</span> <span class="id">dt</span>) <span class="id">ex</span>; <span class="id">mret</span> <span class="id">v</span><br/>
&nbsp;&nbsp;<span class="kwd">in</span><br/>
&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">o</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;| <span class="id">EXP_Ident</span> <span class="id">i</span> =&gt; <span class="id">lift_err_d</span> (<span class="id">lookup_id</span> <span class="id">g</span> <span class="id">e</span> <span class="id">i</span>) <span class="id">mret</span><br/>
<br/>
&nbsp;&nbsp;| <span class="id">EXP_Integer</span> <span class="id">x</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">top</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">None</span> =&gt;  <span class="id">failwith</span> "<span class="id">eval_exp</span> <span class="id">given</span> <span class="id">untyped</span> <span class="id">EXP_Integer</span>"<br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">Some</span> (<span class="id">DTYPE_I</span> <span class="id">bits</span>) =&gt; <span class="tactic">do</span> <span class="id">w</span> &lt;- <span class="id">coerce_integer_to_int</span> <span class="id">bits</span> <span class="id">x</span>; <span class="id">mret</span> <span class="id">w</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">_</span> =&gt; <span class="id">failwith</span> "<span class="id">bad</span> <span class="id">type</span> <span class="kwd">for</span> <span class="id">constant</span> <span class="id">int</span>"<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">end</span><br/>
<br/>
&nbsp;&nbsp;| <span class="id">EXP_Float</span> <span class="id">x</span>   =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">top</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">None</span> =&gt; <span class="id">failwith</span> "<span class="id">eval_exp</span> <span class="id">given</span> <span class="id">untyped</span> <span class="id">EXP_Float</span>"<br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">Some</span> <span class="id">DTYPE_Float</span>  =&gt;  <span class="id">mret</span> (<span class="id">DVALUE_Float</span> (<span class="id">Float32.of_double</span> <span class="id">x</span>))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">Some</span> <span class="id">DTYPE_Double</span> =&gt;  <span class="id">mret</span> (<span class="id">DVALUE_Double</span> <span class="id">x</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">_</span> =&gt; <span class="id">failwith</span> "<span class="id">bad</span> <span class="id">type</span> <span class="kwd">for</span> <span class="id">constant</span> <span class="id">float</span>"<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">end</span><br/>
<br/>
&nbsp;&nbsp;| <span class="id">EXP_Hex</span> <span class="id">x</span>     =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">top</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">None</span> =&gt; <span class="id">failwith</span> "<span class="id">eval_exp</span> <span class="id">given</span> <span class="id">untyped</span> <span class="id">EXP_Hex</span>"<br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">Some</span> <span class="id">DTYPE_Float</span>  =&gt;  <span class="id">mret</span> (<span class="id">DVALUE_Float</span> (<span class="id">Float32.of_double</span> <span class="id">x</span>))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">Some</span> <span class="id">DTYPE_Double</span> =&gt;  <span class="id">mret</span> (<span class="id">DVALUE_Double</span> <span class="id">x</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">_</span> =&gt; <span class="id">failwith</span> "<span class="id">bad</span> <span class="id">type</span> <span class="kwd">for</span> <span class="id">constant</span> <span class="id">hex</span> <span class="id">float</span>"<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">end</span><br/>
<br/>
&nbsp;&nbsp;| <span class="id">EXP_Bool</span> <span class="id">b</span>    =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">b</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">true</span>  =&gt; <span class="id">mret</span> (<span class="id">DVALUE_I1</span> <span class="id">Int1.one</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">false</span> =&gt; <span class="id">mret</span> (<span class="id">DVALUE_I1</span> <span class="id">Int1.zero</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">end</span><br/>
<br/>
&nbsp;&nbsp;| <span class="id">EXP_Null</span> =&gt; <span class="id">mret</span> (<span class="id">DVALUE_Addr</span> <span class="id">A.null</span>)<br/>
<br/>
&nbsp;&nbsp;| <span class="id">EXP_Zero_initializer</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">top</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">None</span> =&gt; <span class="id">failwith</span> "<span class="id">eval_exp</span> <span class="id">given</span> <span class="id">untyped</span> <span class="id">EXP_Zero_initializer</span>"<br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">Some</span> <span class="id">t</span> =&gt; <span class="tactic">do</span> <span class="id">w</span> &lt;- <span class="id">dv_zero_initializer</span> <span class="id">t</span>; <span class="id">mret</span> <span class="id">w</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">end</span><br/>
<br/>
&nbsp;&nbsp;| <span class="id">EXP_Cstring</span> <span class="id">s</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">failwith</span> "<span class="id">EXP_Cstring</span> <span class="id">not</span> <span class="id">yet</span> <span class="id">implemented</span>"<br/>
<br/>
&nbsp;&nbsp;| <span class="id">EXP_Undef</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">top</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">None</span> =&gt; <span class="id">failwith</span> "<span class="id">eval_exp</span> <span class="id">given</span> <span class="id">untyped</span> <span class="id">EXP_Undef</span>"<br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">Some</span> <span class="id">t</span> =&gt; <span class="id">mret</span> <span class="id">DVALUE_Undef</span>  <br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">end</span><br/>
<br/>
&nbsp;&nbsp;| <span class="id">EXP_Struct</span> <span class="id">es</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;'<span class="id">vs</span> &lt;- <span class="id">map_monad</span> <span class="id">eval_texp</span> <span class="id">es</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">mret</span> (<span class="id">DVALUE_Struct</span> <span class="id">vs</span>)<br/>
<br/>
&nbsp;&nbsp;| <span class="id">EXP_Packed_struct</span> <span class="id">es</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">top</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">None</span> =&gt; <span class="id">failwith</span> "<span class="id">eval_exp</span> <span class="id">given</span> <span class="id">untyped</span> <span class="id">EXP_Struct</span>"<br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">Some</span> (<span class="id">DTYPE_Packed_struct</span> <span class="id">_</span>) =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'<span class="id">vs</span> &lt;- <span class="id">map_monad</span> <span class="id">eval_texp</span> <span class="id">es</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">mret</span> (<span class="id">DVALUE_Packed_struct</span> <span class="id">vs</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">_</span> =&gt; <span class="id">failwith</span> "<span class="id">bad</span> <span class="id">type</span> <span class="kwd">for</span> <span class="id">VALUE_Packed_struct</span>"<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">end</span><br/>
<br/>
&nbsp;&nbsp;| <span class="id">EXP_Array</span> <span class="id">es</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;'<span class="id">vs</span> &lt;- <span class="id">map_monad</span> <span class="id">eval_texp</span> <span class="id">es</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">mret</span> (<span class="id">DVALUE_Array</span> <span class="id">vs</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<br/>
&nbsp;&nbsp;| <span class="id">EXP_Vector</span> <span class="id">es</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;'<span class="id">vs</span> &lt;- <span class="id">map_monad</span> <span class="id">eval_texp</span> <span class="id">es</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">mret</span> (<span class="id">DVALUE_Vector</span> <span class="id">vs</span>)<br/>
<br/>
&nbsp;&nbsp;| <span class="id">OP_IBinop</span> <span class="id">iop</span> <span class="id">t</span> <span class="id">op1</span> <span class="id">op2</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">let</span> <span class="id">dt</span> := <span class="id">eval_typ</span> <span class="id">t</span> <span class="kwd">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;'<span class="id">v1</span> &lt;- <span class="id">eval_exp</span> (<span class="id">Some</span> <span class="id">dt</span>) <span class="id">op1</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;'<span class="id">v2</span> &lt;- <span class="id">eval_exp</span> (<span class="id">Some</span> <span class="id">dt</span>) <span class="id">op2</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">do</span> <span class="id">w</span> &lt;- <span class="id">eval_iop</span> <span class="id">iop</span> <span class="id">v1</span> <span class="id">v2</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">mret</span> <span class="id">w</span><br/>
<br/>
&nbsp;&nbsp;| <span class="id">OP_ICmp</span> <span class="id">cmp</span> <span class="id">t</span> <span class="id">op1</span> <span class="id">op2</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">let</span> <span class="id">dt</span> := <span class="id">eval_typ</span> <span class="id">t</span> <span class="kwd">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;'<span class="id">v1</span> &lt;- <span class="id">eval_exp</span> (<span class="id">Some</span> <span class="id">dt</span>) <span class="id">op1</span>;                   <br/>
&nbsp;&nbsp;&nbsp;&nbsp;'<span class="id">v2</span> &lt;- <span class="id">eval_exp</span> (<span class="id">Some</span> <span class="id">dt</span>) <span class="id">op2</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">do</span> <span class="id">w</span> &lt;- (<span class="id">eval_icmp</span> <span class="id">cmp</span>) <span class="id">v1</span> <span class="id">v2</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">mret</span> <span class="id">w</span><br/>
<br/>
&nbsp;&nbsp;| <span class="id">OP_FBinop</span> <span class="id">fop</span> <span class="id">fm</span> <span class="id">t</span> <span class="id">op1</span> <span class="id">op2</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">let</span> <span class="id">dt</span> := <span class="id">eval_typ</span> <span class="id">t</span> <span class="kwd">in</span>    <br/>
&nbsp;&nbsp;&nbsp;&nbsp;'<span class="id">v1</span> &lt;- <span class="id">eval_exp</span> (<span class="id">Some</span> <span class="id">dt</span>) <span class="id">op1</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;'<span class="id">v2</span> &lt;- <span class="id">eval_exp</span> (<span class="id">Some</span> <span class="id">dt</span>) <span class="id">op2</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">do</span> <span class="id">w</span> &lt;- <span class="id">eval_fop</span> <span class="id">fop</span> <span class="id">v1</span> <span class="id">v2</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">mret</span> <span class="id">w</span><br/>
<br/>
&nbsp;&nbsp;| <span class="id">OP_FCmp</span> <span class="id">fcmp</span> <span class="id">t</span> <span class="id">op1</span> <span class="id">op2</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">let</span> <span class="id">dt</span> := <span class="id">eval_typ</span> <span class="id">t</span> <span class="kwd">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;'<span class="id">v1</span> &lt;- <span class="id">eval_exp</span> (<span class="id">Some</span> <span class="id">dt</span>) <span class="id">op1</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;'<span class="id">v2</span> &lt;- <span class="id">eval_exp</span> (<span class="id">Some</span> <span class="id">dt</span>) <span class="id">op2</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">do</span> <span class="id">w</span> &lt;- <span class="id">eval_fcmp</span> <span class="id">fcmp</span> <span class="id">v1</span> <span class="id">v2</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">mret</span> <span class="id">w</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br/>
&nbsp;&nbsp;| <span class="id">OP_Conversion</span> <span class="id">conv</span> <span class="id">t1</span> <span class="id">op</span> <span class="id">t2</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">let</span> <span class="id">dt1</span> := <span class="id">eval_typ</span> <span class="id">t1</span> <span class="kwd">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;'<span class="id">v</span> &lt;- <span class="id">eval_exp</span> (<span class="id">Some</span> <span class="id">dt1</span>) <span class="id">op</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">eval_conv</span> <span class="id">conv</span> <span class="id">t1</span> <span class="id">v</span> <span class="id">t2</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br/>
&nbsp;&nbsp;| <span class="id">OP_GetElementPtr</span> <span class="id">_</span> (<span class="id">TYPE_Pointer</span> <span class="id">t</span>, <span class="id">ptrval</span>) <span class="id">idxs</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">let</span> <span class="id">dt</span> := <span class="id">eval_typ</span> <span class="id">t</span> <span class="kwd">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;'<span class="id">vptr</span> &lt;- <span class="id">eval_exp</span> (<span class="id">Some</span> <span class="id">DTYPE_Pointer</span>) <span class="id">ptrval</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;'<span class="id">vs</span> &lt;- <span class="id">map_monad</span> (<span class="kwd">fun</span> '(<span class="id">_</span>, <span class="id">index</span>) =&gt; <span class="id">eval_exp</span> (<span class="id">Some</span> (<span class="id">DTYPE_I</span> 32)) <span class="id">index</span>) <span class="id">idxs</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">Trace.Vis</span> (<span class="id">GEP</span> <span class="id">dt</span> <span class="id">vptr</span> <span class="id">vs</span>) <span class="id">mret</span><br/>
<br/>
&nbsp;&nbsp;| <span class="id">OP_GetElementPtr</span> <span class="id">_</span> (<span class="id">_</span>, <span class="id">_</span>) <span class="id">_</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">failwith</span> "<span class="id">getelementptr</span> <span class="id">has</span> <span class="id">non</span>-<span class="id">pointer</span> <span class="id">type</span> <span class="id">annotation</span>"<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<br/>
&nbsp;&nbsp;| <span class="id">OP_ExtractElement</span> <span class="id">vecop</span> <span class="id">idx</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">failwith</span> "<span class="id">extractelement</span> <span class="id">not</span> <span class="id">implemented</span>"  <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br/>
&nbsp;&nbsp;| <span class="id">OP_InsertElement</span> <span class="id">vecop</span> <span class="id">eltop</span> <span class="id">idx</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">failwith</span> "<span class="id">insertelement</span> <span class="id">not</span> <span class="id">implemented</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;<br/>
&nbsp;&nbsp;| <span class="id">OP_ShuffleVector</span> <span class="id">vecop1</span> <span class="id">vecop2</span> <span class="id">idxmask</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">failwith</span> "<span class="id">shufflevector</span> <span class="id">not</span> <span class="id">implemented</span>" <br/>
<br/>
&nbsp;&nbsp;| <span class="id">OP_ExtractValue</span> <span class="id">strop</span> <span class="id">idxs</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">let</span> '(<span class="id">t</span>, <span class="id">str</span>) := <span class="id">strop</span> <span class="kwd">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">let</span> <span class="id">dt</span> := <span class="id">eval_typ</span> <span class="id">t</span> <span class="kwd">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;'<span class="id">str</span> &lt;- <span class="id">eval_exp</span> (<span class="id">Some</span> <span class="id">dt</span>) <span class="id">str</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">let</span> <span class="id">fix</span> <span class="id">loop</span> <span class="id">str</span> <span class="id">idxs</span> : <span class="id">err</span> <span class="id">dvalue</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">idxs</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| [] =&gt; <span class="id">mret</span> <span class="id">str</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">i</span> :: <span class="id">tl</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'<span class="id">v</span> &lt;- <span class="id">index_into_str</span> <span class="id">str</span> <span class="id">i</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">loop</span> <span class="id">v</span> <span class="id">tl</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">end</span> <span class="kwd">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">do</span> <span class="id">w</span> &lt;- <span class="id">loop</span> <span class="id">str</span> <span class="id">idxs</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">mret</span> <span class="id">w</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br/>
&nbsp;&nbsp;| <span class="id">OP_InsertValue</span> <span class="id">strop</span> <span class="id">eltop</span> <span class="id">idxs</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">failwith</span> "<span class="id">TODO</span>"<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<br/>
&nbsp;&nbsp;| <span class="id">OP_Select</span> (<span class="id">t</span>, <span class="id">cnd</span>) (<span class="id">t1</span>, <span class="id">op1</span>) (<span class="id">t2</span>, <span class="id">op2</span>) =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">let</span> <span class="id">dt</span> := <span class="id">eval_typ</span> <span class="id">t</span> <span class="kwd">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">let</span> <span class="id">dt1</span> := <span class="id">eval_typ</span> <span class="id">t1</span> <span class="kwd">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">let</span> <span class="id">dt2</span> := <span class="id">eval_typ</span> <span class="id">t2</span> <span class="kwd">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;'<span class="id">cndv</span> &lt;- <span class="id">eval_exp</span> (<span class="id">Some</span> <span class="id">dt</span>) <span class="id">cnd</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;'<span class="id">v1</span> &lt;- <span class="id">eval_exp</span> (<span class="id">Some</span> <span class="id">dt1</span>) <span class="id">op1</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;'<span class="id">v2</span> &lt;- <span class="id">eval_exp</span> (<span class="id">Some</span> <span class="id">dt2</span>) <span class="id">op2</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">do</span> <span class="id">w</span> &lt;- <span class="id">eval_select</span> <span class="id">cndv</span> <span class="id">v1</span> <span class="id">v2</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">mret</span> <span class="id">w</span><br/>
&nbsp;&nbsp;<span class="kwd">end</span>.<br/>
<span class="id">Arguments</span> <span class="id">eval_exp</span> <span class="id">_</span> <span class="id">_</span> : <span class="tactic">simpl</span> <span class="id">nomatch</span>.<br/>
<br/>
<span class="kwd">Definition</span> <span class="id">eval_op</span> (<span class="id">o</span>:<span class="id">exp</span>) : <span class="id">Trace</span> <span class="id">dvalue</span> :=<br/>
&nbsp;&nbsp;<span class="id">eval_exp</span> <span class="id">None</span> <span class="id">o</span>.<br/>
<span class="id">Arguments</span> <span class="id">eval_op</span> <span class="id">_</span> : <span class="tactic">simpl</span> <span class="id">nomatch</span>.<br/>
<br/>
<span class="kwd">End</span> <span class="id">IN_LOCAL_ENVIRONMENT</span>.<br/>
<br/>
<br/>
<span class="kwd">Inductive</span> <span class="id">result</span> :=<br/>
| <span class="id">Done</span> (<span class="id">v</span>:<span class="id">dvalue</span>)<br/>
| <span class="id">Step</span> (<span class="id">s</span>:<span class="id">state</span>)<br/>
.       <br/>
<br/>
<span class="kwd">Definition</span> <span class="id">raise_p</span> {<span class="id">X</span>} (<span class="id">p</span>:<span class="id">pc</span>) <span class="id">s</span> : <span class="id">Trace</span> <span class="id">X</span> := <span class="id">raise</span> (<span class="id">s</span> ++ ": " ++ (<span class="id">string_of</span> <span class="id">p</span>)).<br/>
<span class="kwd">Definition</span> <span class="id">cont</span> (<span class="id">s</span>:<span class="id">state</span>)  : <span class="id">Trace</span> <span class="id">result</span> := <span class="id">mret</span> (<span class="id">Step</span> <span class="id">s</span>).<br/>
<span class="kwd">Definition</span> <span class="id">halt</span> (<span class="id">v</span>:<span class="id">dvalue</span>) : <span class="id">Trace</span> <span class="id">result</span> := <span class="id">mret</span> (<span class="id">Done</span> <span class="id">v</span>).<br/>
<br/>
&nbsp;&nbsp;<br/>
<span class="kwd">Definition</span> <span class="id">jump</span> (<span class="id">fid</span>:<span class="id">function_id</span>) (<span class="id">bid_src</span>:<span class="id">block_id</span>) (<span class="id">bid_tgt</span>:<span class="id">block_id</span>) (<span class="id">g</span>:<span class="id">genv</span>) (<span class="id">e_init</span>:<span class="id">env</span>) (<span class="id">k</span>:<span class="id">stack</span>) : <span class="id">Trace</span> <span class="id">result</span> :=<br/>
&nbsp;&nbsp;<span class="kwd">let</span> <span class="id">eval_phi</span> (<span class="id">e</span>:<span class="id">env</span>) '(<span class="id">iid</span>, <span class="id">Phi</span> <span class="id">t</span> <span class="id">ls</span>) :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">assoc</span> <span class="id">RawIDOrd.eq_dec</span> <span class="id">bid_src</span> <span class="id">ls</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">Some</span> <span class="id">op</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">let</span> <span class="id">dt</span> := <span class="id">eval_typ</span> <span class="id">t</span> <span class="kwd">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'<span class="id">dv</span> &lt;- <span class="id">eval_exp</span> <span class="id">g</span> <span class="id">e_init</span> (<span class="id">Some</span> <span class="id">dt</span>) <span class="id">op</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">mret</span> (<span class="id">add_env</span> <span class="id">iid</span> <span class="id">dv</span> <span class="id">e</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">None</span> =&gt; <span class="id">failwith</span> ("<span class="id">jump</span>: <span class="id">block</span> " ++ <span class="id">string_of</span> <span class="id">bid_src</span> ++ " <span class="id">not</span> <span class="id">found</span> <span class="kwd">in</span> " ++ <span class="id">string_of</span> <span class="id">iid</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">end</span><br/>
&nbsp;&nbsp;<span class="kwd">in</span><br/>
&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">find_block_entry</span> <span class="id">CFG</span> <span class="id">fid</span> <span class="id">bid_tgt</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;| <span class="id">None</span> =&gt; <span class="id">raise</span> ("<span class="id">jump</span>: <span class="id">target</span> <span class="id">block</span> " ++ <span class="id">string_of</span> <span class="id">bid_tgt</span> ++ " <span class="id">not</span> <span class="id">found</span>")<br/>
&nbsp;&nbsp;| <span class="id">Some</span> (<span class="id">BlockEntry</span> <span class="id">phis</span> <span class="id">pc_entry</span>) =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'<span class="id">e_out</span> &lt;- <span class="id">monad_fold_right</span> <span class="id">eval_phi</span> <span class="id">phis</span> <span class="id">e_init</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">cont</span> (<span class="id">g</span>, <span class="id">pc_entry</span>, <span class="id">e_out</span>, <span class="id">k</span>)<br/>
&nbsp;&nbsp;<span class="kwd">end</span>.<br/>
<br/>
<span class="kwd">Definition</span> <span class="id">step</span> (<span class="id">s</span>:<span class="id">state</span>) : <span class="id">Trace</span> <span class="id">result</span> :=<br/>
&nbsp;&nbsp;<span class="kwd">let</span> '(<span class="id">g</span>, <span class="id">pc</span>, <span class="id">e</span>, <span class="id">k</span>) := <span class="id">s</span> <span class="kwd">in</span><br/>
&nbsp;&nbsp;<span class="kwd">let</span> <span class="id">eval_exp</span> <span class="id">top</span> <span class="id">exp</span> := <span class="id">eval_exp</span> <span class="id">g</span> <span class="id">e</span> <span class="id">top</span> <span class="id">exp</span> <span class="kwd">in</span><br/>
&nbsp;&nbsp;<br/>
&nbsp;&nbsp;<span class="tactic">do</span> <span class="id">cmd</span> &lt;- <span class="id">trywith</span> ("<span class="id">CFG</span> <span class="id">has</span> <span class="id">no</span> <span class="id">instruction</span> <span class="tactic">at</span> " ++ <span class="id">string_of</span> <span class="id">pc</span>) (<span class="id">fetch</span> <span class="id">CFG</span> <span class="id">pc</span>);<br/>
&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">cmd</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;| <span class="id">Term</span> (<span class="id">TERM_Ret</span> (<span class="id">t</span>, <span class="id">op</span>)) =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;'<span class="id">dv</span> &lt;- <span class="id">eval_exp</span> (<span class="id">Some</span> (<span class="id">eval_typ</span> <span class="id">t</span>)) <span class="id">op</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">k</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| [] =&gt; <span class="id">halt</span> <span class="id">dv</span>       <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| (<span class="id">KRet</span> <span class="id">e</span>' <span class="id">id</span> <span class="id">p</span>') :: <span class="id">k</span>' =&gt; <span class="id">cont</span> (<span class="id">g</span>, <span class="id">p</span>', <span class="id">add_env</span> <span class="id">id</span> <span class="id">dv</span> <span class="id">e</span>', <span class="id">k</span>')<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">_</span> =&gt; <span class="id">raise_p</span> <span class="id">pc</span> "<span class="id">IMPOSSIBLE</span>: <span class="id">Ret</span> <span class="id">op</span> <span class="kwd">in</span> <span class="id">non</span>-<span class="kwd">return</span> <span class="id">configuration</span>" <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">end</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br/>
&nbsp;&nbsp;| <span class="id">Term</span> <span class="id">TERM_Ret_void</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">k</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| [] =&gt; <span class="id">halt</span> <span class="id">DVALUE_None</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| (<span class="id">KRet_void</span> <span class="id">e</span>' <span class="id">p</span>')::<span class="id">k</span>' =&gt; <span class="id">cont</span> (<span class="id">g</span>, <span class="id">p</span>', <span class="id">e</span>', <span class="id">k</span>')<br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">_</span> =&gt; <span class="id">raise_p</span> <span class="id">pc</span> "<span class="id">IMPOSSIBLE</span>: <span class="id">Ret</span> <span class="id">void</span> <span class="kwd">in</span> <span class="id">non</span>-<span class="kwd">return</span> <span class="id">configuration</span>"<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">end</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br/>
&nbsp;&nbsp;| <span class="id">Term</span> (<span class="id">TERM_Br</span> (<span class="id">t</span>,<span class="id">op</span>) <span class="id">br1</span> <span class="id">br2</span>) =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;'<span class="id">dv</span> &lt;- <span class="id">eval_exp</span> (<span class="id">Some</span> (<span class="id">eval_typ</span> <span class="id">t</span>)) <span class="id">op</span>; <br/>
&nbsp;&nbsp;&nbsp;&nbsp;'<span class="id">br</span> &lt;- <span class="kwd">match</span> <span class="id">dv</span> <span class="kwd">with</span> <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">DVALUE_I1</span> <span class="id">comparison_bit</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">if</span> <span class="id">Int1.eq</span> <span class="id">comparison_bit</span> <span class="id">Int1.one</span> <span class="kwd">then</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">mret</span> <span class="id">br1</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">else</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">mret</span> <span class="id">br2</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">_</span> =&gt; <span class="id">failwith</span> "<span class="id">Br</span> <span class="id">got</span> <span class="id">non</span>-<span class="id">bool</span> <span class="id">value</span>"<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">end</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">jump</span> (<span class="id">fn</span> <span class="id">pc</span>) (<span class="id">bk</span> <span class="id">pc</span>) <span class="id">br</span> <span class="id">g</span> <span class="id">e</span> <span class="id">k</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br/>
&nbsp;&nbsp;| <span class="id">Term</span> (<span class="id">TERM_Br_1</span> <span class="id">br</span>) =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">jump</span> (<span class="id">fn</span> <span class="id">pc</span>) (<span class="id">bk</span> <span class="id">pc</span>) <span class="id">br</span> <span class="id">g</span> <span class="id">e</span> <span class="id">k</span><br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br/>
&nbsp;&nbsp;| <span class="id">Term</span> (<span class="id">TERM_Switch</span> <span class="id">_</span> <span class="id">_</span> <span class="id">_</span>)<br/>
&nbsp;&nbsp;| <span class="id">Term</span> (<span class="id">TERM_IndirectBr</span> <span class="id">_</span> <span class="id">_</span>)<br/>
&nbsp;&nbsp;| <span class="id">Term</span> (<span class="id">TERM_Resume</span> <span class="id">_</span>)<br/>
&nbsp;&nbsp;| <span class="id">Term</span> (<span class="id">TERM_Invoke</span> <span class="id">_</span> <span class="id">_</span> <span class="id">_</span> <span class="id">_</span>) =&gt; <span class="id">raise_p</span> <span class="id">pc</span> "<span class="id">Unsupport</span> <span class="id">LLVM</span> <span class="id">terminator</span>" <br/>
<br/>
&nbsp;&nbsp;| <span class="id">Inst</span> <span class="id">insn</span> =&gt;  <br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">do</span> <span class="id">pc_next</span> &lt;- <span class="id">trywith</span> "<span class="id">no</span> <span class="id">fallthrough</span> <span class="id">instruction</span>" (<span class="id">incr_pc</span> <span class="id">CFG</span> <span class="id">pc</span>);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">match</span> (<span class="id">pt</span> <span class="id">pc</span>), <span class="id">insn</span>  <span class="kwd">with</span><br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">IId</span> <span class="id">id</span>, <span class="id">INSTR_Op</span> <span class="id">op</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'<span class="id">dv</span> &lt;- <span class="id">eval_op</span> <span class="id">g</span> <span class="id">e</span> <span class="id">op</span>;     <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">cont</span> (<span class="id">g</span>, <span class="id">pc_next</span>, <span class="id">add_env</span> <span class="id">id</span> <span class="id">dv</span> <span class="id">e</span>, <span class="id">k</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">IId</span> <span class="id">id</span>, <span class="id">INSTR_Alloca</span> <span class="id">t</span> <span class="id">_</span> <span class="id">_</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">Trace.Vis</span> (<span class="id">Alloca</span> (<span class="id">eval_typ</span> <span class="id">t</span>)) (<span class="kwd">fun</span> (<span class="id">a</span>:<span class="id">dvalue</span>) =&gt;  <span class="id">cont</span> (<span class="id">g</span>, <span class="id">pc_next</span>, <span class="id">add_env</span> <span class="id">id</span> <span class="id">a</span> <span class="id">e</span>, <span class="id">k</span>))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">IId</span> <span class="id">id</span>, <span class="id">INSTR_Load</span> <span class="id">_</span> <span class="id">t</span> (<span class="id">u</span>,<span class="id">ptr</span>) <span class="id">_</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'<span class="id">dv</span> &lt;- <span class="id">eval_exp</span> (<span class="id">Some</span> (<span class="id">eval_typ</span> <span class="id">u</span>)) <span class="id">ptr</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">Trace.Vis</span> (<span class="kwd">Load</span> (<span class="id">eval_typ</span> <span class="id">t</span>) <span class="id">dv</span>) (<span class="kwd">fun</span> <span class="id">dv</span> =&gt; <span class="id">cont</span> (<span class="id">g</span>, <span class="id">pc_next</span>, <span class="id">add_env</span> <span class="id">id</span> <span class="id">dv</span> <span class="id">e</span>, <span class="id">k</span>))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">IVoid</span> <span class="id">_</span>, <span class="id">INSTR_Store</span> <span class="id">_</span> (<span class="id">t</span>, <span class="id">val</span>) (<span class="id">u</span>, <span class="id">ptr</span>) <span class="id">_</span> =&gt; <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'<span class="id">dv</span> &lt;- <span class="id">eval_exp</span> (<span class="id">Some</span> (<span class="id">eval_typ</span> <span class="id">t</span>)) <span class="id">val</span>; <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'<span class="id">v</span> &lt;- <span class="id">eval_exp</span> (<span class="id">Some</span> (<span class="id">eval_typ</span> <span class="id">u</span>)) <span class="id">ptr</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">Trace.Vis</span> (<span class="id">Store</span> <span class="id">v</span> <span class="id">dv</span>) (<span class="kwd">fun</span> <span class="id">_</span> =&gt; <span class="id">cont</span> (<span class="id">g</span>, <span class="id">pc_next</span>, <span class="id">e</span>, <span class="id">k</span>))<br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">_</span>, <span class="id">INSTR_Store</span> <span class="id">_</span> <span class="id">_</span> <span class="id">_</span> <span class="id">_</span> =&gt; <span class="id">raise</span> "<span class="id">ERROR</span>: <span class="id">Store</span> <span class="id">to</span> <span class="id">non</span>-<span class="id">void</span> <span class="id">ID</span>" <br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">pt</span>, <span class="id">INSTR_Call</span> (<span class="id">t</span>, <span class="id">f</span>) <span class="id">args</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'<span class="id">fv</span> &lt;- <span class="id">eval_exp</span> <span class="id">None</span> <span class="id">f</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'<span class="id">dvs</span> &lt;-  <span class="id">map_monad</span> (<span class="kwd">fun</span> '(<span class="id">t</span>, <span class="id">op</span>) =&gt; (<span class="id">eval_exp</span> (<span class="id">Some</span> (<span class="id">eval_typ</span> <span class="id">t</span>)) <span class="id">op</span>)) <span class="id">args</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">fv</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">DVALUE_Addr</span> <span class="id">addr</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">do</span> <span class="id">fid</span> &lt;- <span class="id">reverse_lookup_function_id</span> <span class="id">g</span> <span class="id">addr</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">match</span> (<span class="id">find_function_entry</span> <span class="id">CFG</span> <span class="id">fid</span>) <span class="kwd">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">Some</span> <span class="id">fnentry</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">let</span> '<span class="id">FunctionEntry</span> <span class="id">ids</span> <span class="id">pc_f</span> := <span class="id">fnentry</span> <span class="kwd">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">do</span> <span class="id">bs</span> &lt;- <span class="id">combine_lists_err</span> <span class="id">ids</span> <span class="id">dvs</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">let</span> <span class="id">env</span> := <span class="id">env_of_assoc</span> <span class="id">bs</span> <span class="kwd">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">pt</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">IVoid</span> <span class="id">_</span> =&gt; <span class="id">cont</span> (<span class="id">g</span>, <span class="id">pc_f</span>, <span class="id">env</span>, (<span class="id">KRet_void</span> <span class="id">e</span> <span class="id">pc_next</span>::<span class="id">k</span>))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">IId</span> <span class="id">id</span> =&gt;  <span class="id">cont</span> (<span class="id">g</span>, <span class="id">pc_f</span>, <span class="id">env</span>, (<span class="id">KRet</span> <span class="id">e</span> <span class="id">id</span> <span class="id">pc_next</span>::<span class="id">k</span>))          <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">end</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">None</span> =&gt; <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">fid</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">Name</span> <span class="id">s</span> =&gt; <span class="id">Trace.Vis</span> (<span class="id">Call</span> <span class="id">DTYPE_Void</span> <span class="id">s</span> <span class="id">dvs</span>) (<span class="kwd">fun</span> <span class="id">dv</span> =&gt; <span class="id">cont</span> (<span class="id">g</span>, <span class="id">pc_next</span>, <span class="id">e</span>, <span class="id">k</span>))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">_</span> =&gt; <span class="id">raise</span> ("<span class="id">step</span>: <span class="id">no</span> <span class="id">function</span> " ++ (<span class="id">string_of</span> <span class="id">fid</span>))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">end</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">end</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">_</span> =&gt; <span class="id">raise_p</span> <span class="id">pc</span> "<span class="id">call</span> <span class="id">got</span> <span class="id">non</span>-<span class="id">function</span> <span class="id">pointer</span>"<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">end</span><br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">_</span>, <span class="id">INSTR_Unreachable</span> =&gt; <span class="id">raise_p</span> <span class="id">pc</span> "<span class="id">IMPOSSIBLE</span>: <span class="id">unreachable</span> <span class="kwd">in</span> <span class="id">reachable</span> <span class="id">position</span>" <br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">_</span>, <span class="id">INSTR_Fence</span> <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">_</span>, <span class="id">INSTR_AtomicCmpXchg</span> <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">_</span>, <span class="id">INSTR_AtomicRMW</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">_</span>, <span class="id">INSTR_VAArg</span> <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">_</span>, <span class="id">INSTR_LandingPad</span> =&gt; <span class="id">raise_p</span> <span class="id">pc</span> "<span class="id">Unsupported</span> <span class="id">LLVM</span> <span class="id">instruction</span>"<br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">_</span>, <span class="id">_</span> =&gt; <span class="id">raise_p</span> <span class="id">pc</span> "<span class="id">ID</span> / <span class="id">Instr</span> <span class="id">mismatch</span> <span class="id">void</span>/<span class="id">non</span>-<span class="id">void</span>"<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">end</span><br/>
&nbsp;&nbsp;<span class="kwd">end</span>.<br/>
<br/>
<br/>
<span class="kwd">Definition</span> <span class="id">allocate_globals</span> (<span class="id">gs</span>:<span class="id">list</span> <span class="id">global</span>) : <span class="id">Trace</span> <span class="id">genv</span> :=<br/>
&nbsp;&nbsp;<span class="id">monad_fold_right</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="kwd">fun</span> (<span class="id">m</span>:<span class="id">genv</span>) (<span class="id">g</span>:<span class="id">global</span>) =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">Trace.Vis</span> (<span class="id">Alloca</span> (<span class="id">eval_typ</span> (<span class="id">g_typ</span> <span class="id">g</span>))) (<span class="kwd">fun</span> <span class="id">v</span> =&gt; <span class="id">mret</span> (<span class="id">ENV.add</span> (<span class="id">g_ident</span> <span class="id">g</span>) <span class="id">v</span> <span class="id">m</span>))) <span class="id">gs</span> (@<span class="id">ENV.empty</span> <span class="id">_</span>).<br/>
<br/>
<br/>
<span class="kwd">Definition</span> <span class="id">register_declaration</span> (<span class="id">g</span>:<span class="id">genv</span>) (<span class="id">d</span>:<span class="id">declaration</span>) : <span class="id">Trace</span> <span class="id">genv</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">Trace.Vis</span> (<span class="id">Alloca</span> <span class="id">DTYPE_Pointer</span>) (<span class="kwd">fun</span> <span class="id">v</span> =&gt; <span class="id">mret</span> (<span class="id">ENV.add</span> (<span class="id">dc_name</span> <span class="id">d</span>) <span class="id">v</span> <span class="id">g</span>)).<br/>
<br/>
<span class="kwd">Definition</span> <span class="id">register_functions</span> (<span class="id">g</span>:<span class="id">genv</span>) : <span class="id">Trace</span> <span class="id">genv</span> :=<br/>
&nbsp;&nbsp;<span class="id">monad_fold_right</span> <span class="id">register_declaration</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;((<span class="id">m_declarations</span> <span class="id">CFG</span>) ++ (<span class="id">List.map</span> <span class="id">df_prototype</span> (<span class="id">m_definitions</span> <span class="id">CFG</span>)))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">g</span>.<br/>
&nbsp;&nbsp;<br/>
<span class="kwd">Definition</span> <span class="id">initialize_globals</span> (<span class="id">gs</span>:<span class="id">list</span> <span class="id">global</span>) (<span class="id">g</span>:<span class="id">genv</span>) : <span class="id">Trace</span> <span class="id">unit</span> :=<br/>
&nbsp;&nbsp;<span class="id">monad_fold_right</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="kwd">fun</span> (<span class="id">_</span>:<span class="id">unit</span>) (<span class="id">glb</span>:<span class="id">global</span>) =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">let</span> <span class="id">dt</span> := <span class="id">eval_typ</span> (<span class="id">g_typ</span> <span class="id">glb</span>) <span class="kwd">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tactic">do</span> <span class="id">a</span> &lt;- <span class="id">lookup_env</span> <span class="id">g</span> (<span class="id">g_ident</span> <span class="id">glb</span>);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'<span class="id">dv</span> &lt;-<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">match</span> (<span class="id">g_exp</span> <span class="id">glb</span>) <span class="kwd">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">None</span> =&gt; <span class="id">mret</span> <span class="id">DVALUE_Undef</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">Some</span> <span class="id">e</span> =&gt; <span class="id">eval_exp</span> <span class="id">g</span> (@<span class="id">ENV.empty</span> <span class="id">_</span>) (<span class="id">Some</span> <span class="id">dt</span>) <span class="id">e</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">end</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">Trace.Vis</span> (<span class="id">Store</span> <span class="id">a</span> <span class="id">dv</span>) <span class="id">mret</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">gs</span> <span class="id">tt</span>.<br/>
&nbsp;&nbsp;<br/>
<span class="kwd">Definition</span> <span class="id">build_global_environment</span> : <span class="id">Trace</span> <span class="id">genv</span> :=<br/>
&nbsp;&nbsp;'<span class="id">g</span> &lt;- <span class="id">allocate_globals</span> (<span class="id">m_globals</span> <span class="id">CFG</span>);<br/>
&nbsp;&nbsp;'<span class="id">g2</span> &lt;- <span class="id">register_functions</span> <span class="id">g</span>;<br/>
&nbsp;&nbsp;'<span class="id">_</span> &lt;- <span class="id">initialize_globals</span> (<span class="id">m_globals</span> <span class="id">CFG</span>) <span class="id">g2</span>;<br/>
&nbsp;&nbsp;<span class="id">mret</span> <span class="id">g2</span>.<br/>
<br/>
<span class="kwd">Definition</span> <span class="id">init_state</span> (<span class="id">fname</span>:<span class="id">string</span>) : <span class="id">Trace</span> <span class="id">state</span> :=<br/>
&nbsp;&nbsp;'<span class="id">g</span> &lt;- <span class="id">build_global_environment</span>;<br/>
&nbsp;&nbsp;'<span class="id">fentry</span> &lt;- <span class="id">trywith</span> ("<span class="id">INIT</span>: <span class="id">no</span> <span class="id">function</span> <span class="id">named</span> " ++ <span class="id">fname</span>) (<span class="id">find_function_entry</span> <span class="id">CFG</span> (<span class="id">Name</span> <span class="id">fname</span>));<br/>
&nbsp;&nbsp;<span class="kwd">let</span> '<span class="id">FunctionEntry</span> <span class="id">ids</span> <span class="id">pc_f</span> := <span class="id">fentry</span> <span class="kwd">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">mret</span> (<span class="id">g</span>, <span class="id">pc_f</span>, (@<span class="id">ENV.empty</span> <span class="id">dvalue</span>), []).<br/>
<br/>
<span class="kwd">CoFixpoint</span> <span class="id">step_sem</span> (<span class="id">r</span>:<span class="id">result</span>) : <span class="id">Trace</span> <span class="id">dvalue</span> :=<br/>
&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">r</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;| <span class="id">Done</span> <span class="id">v</span> =&gt; <span class="id">mret</span> <span class="id">v</span><br/>
&nbsp;&nbsp;| <span class="id">Step</span> <span class="id">s</span> =&gt; '<span class="id">x</span> &lt;- <span class="id">step</span> <span class="id">s</span> ; <span class="id">step_sem</span> <span class="id">x</span><br/>
&nbsp;&nbsp;<span class="kwd">end</span>.<br/>
<br/>
<span class="kwd">End</span> <span class="id">IN_CFG_CONTEXT</span>.<br/>
<br/>
<span class="kwd">End</span> <span class="id">StepSemantics</span>.<br/>
</div>
<div class="footer"><hr/>Generated by coq2html</div>
</body>
</html>
